<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uni - V16 Stable Timer & Chart</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        accent: '#8b5cf6',
                        darkbg: '#0f172a',
                        darkcard: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    },
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        [v-cloak] { display: none !important; }
        
        .page-enter-active, .page-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .page-enter-from { opacity: 0; transform: translateY(10px); }
        .page-leave-to { opacity: 0; transform: translateY(-10px); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .input-elegant { 
            width: 100%; padding: 12px 16px; border-radius: 12px; 
            background-color: #f8fafc; border: 1px solid #e2e8f0; 
            outline: none; font-weight: 500; transition: all 0.2s; 
        }
        .dark .input-elegant { 
            background-color: #1e293b; border-color: #334155; color: white; 
        }
        .input-elegant:focus { 
            border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); 
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-800 dark:bg-darkbg dark:text-slate-200 h-screen overflow-hidden selection:bg-primary selection:text-white font-sans">

<div id="app" v-cloak class="flex h-full">

    <aside class="w-20 lg:w-64 flex-shrink-0 flex flex-col bg-white dark:bg-darkcard border-r border-gray-200 dark:border-slate-800 h-full z-30 shadow-sm transition-all duration-300">
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-gray-100 dark:border-slate-800">
            <div class="bg-primary text-white p-2 rounded-xl shadow-lg shadow-indigo-500/30">
                <i class="ph-bold ph-student text-xl"></i>
            </div>
            <h1 class="font-bold text-xl ml-3 hidden lg:block tracking-tight">Uni</h1>
        </div>
        
        <div class="hidden lg:flex flex-col px-6 py-4 border-b border-gray-100 dark:border-slate-800">
            <div class="flex items-center justify-between text-xs font-bold uppercase text-slate-400 mb-2">
                <span>Streak</span>
                <i class="ph-fill ph-fire text-orange-500 text-lg animate-pulse"></i>
            </div>
            <div class="text-2xl font-black text-slate-800 dark:text-white">
                {{ userStats.streak }} <span class="text-sm font-medium text-slate-400">giorni</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
            <template v-for="item in navItems" :key="item.id">
                <button @click="currentView = item.id" 
                    :class="['w-full flex items-center justify-center lg:justify-start gap-3 px-3 py-3 rounded-xl transition-all relative', 
                    currentView === item.id ? 'bg-indigo-50 text-primary dark:bg-indigo-500/10 dark:text-indigo-400 font-bold' : 'text-slate-500 hover:bg-gray-100 dark:hover:bg-slate-800 dark:text-slate-400 font-medium']">
                    <i :class="['ph-bold text-xl', item.icon]"></i>
                    <span class="hidden lg:block">{{ item.label }}</span>
                </button>
            </template>
        </nav>

        <div class="p-4 border-t border-gray-200 dark:border-slate-800">
            <button @click="toggleTheme" class="w-full flex items-center justify-center lg:justify-start gap-3 p-3 rounded-xl bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                <i :class="isDark ? 'ph-bold ph-moon' : 'ph-bold ph-sun text-orange-400'"></i>
                <span class="hidden lg:block text-sm font-bold">{{ isDark ? 'Dark Mode' : 'Light Mode' }}</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto relative bg-gray-50 dark:bg-darkbg scroll-smooth">
        <header class="lg:hidden flex items-center justify-between p-4 bg-white dark:bg-darkcard sticky top-0 z-20 border-b dark:border-slate-800 shadow-sm">
            <span class="font-bold text-primary flex items-center gap-2 text-xl"><i class="ph-bold ph-student"></i> Uni</span>
            <div class="flex items-center gap-1 text-orange-500 font-bold text-sm bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-full">
                <i class="ph-fill ph-fire"></i> {{ userStats.streak }}
            </div>
        </header>

        <div class="p-6 lg:p-10 max-w-7xl mx-auto pb-32">
            <transition name="page" mode="out-in">
                
                <div v-if="currentView === 'dashboard'" key="dashboard">
                    <div v-if="alerts.length > 0" class="mb-8 space-y-3">
                        <div v-for="(alert, idx) in alerts" :key="idx" class="p-4 rounded-xl flex items-center gap-3 shadow-sm border-l-4" 
                            :class="alert.type === 'warning' ? 'bg-orange-50 border-orange-400 text-orange-800 dark:bg-orange-900/20 dark:text-orange-200' : 'bg-indigo-50 border-indigo-500 text-indigo-900 dark:bg-indigo-900/20 dark:text-indigo-200'">
                            <i :class="['ph-fill text-xl', alert.icon]"></i>
                            <span class="font-bold text-sm">{{ alert.msg }}</span>
                        </div>
                    </div>

                    <header class="mb-8 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl font-extrabold mb-1 tracking-tight text-slate-900 dark:text-white">Dashboard</h2>
                            <p class="text-slate-500 dark:text-slate-400 font-medium">Panoramica della tua carriera.</p>
                        </div>
                    </header>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white dark:bg-darkcard p-5 rounded-2xl border border-gray-100 dark:border-slate-700 shadow-sm">
                            <div class="flex items-center gap-2 mb-2 text-slate-400 text-xs font-bold uppercase tracking-wider">
                                <i class="ph-bold ph-calculator text-indigo-500"></i> Aritmetica
                            </div>
                            <span class="text-3xl font-bold text-slate-700 dark:text-white">{{ kpi.mediaAritmetica }}</span>
                        </div>
                        </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-darkcard p-6 rounded-2xl border border-gray-100 dark:border-slate-700 shadow-sm">
                            <h3 class="font-bold mb-6 flex items-center gap-2">
                                <span class="w-8 h-8 rounded-lg bg-indigo-50 dark:bg-indigo-500/20 flex items-center justify-center text-primary"><i class="ph-bold ph-trend-up"></i></span> Andamento Voti
                            </h3>
                            <div style="height: 300px; position: relative;"><canvas id="mainChart"></canvas></div>
                        </div>
                        
                        <div class="bg-white dark:bg-darkcard p-6 rounded-2xl border border-gray-100 dark:border-slate-700 shadow-sm flex flex-col">
                            <h3 class="font-bold mb-4 flex items-center gap-2">
                                <span class="w-8 h-8 rounded-lg bg-pink-50 dark:bg-pink-500/20 flex items-center justify-center text-secondary"><i class="ph-bold ph-calendar-check"></i></span> In Arrivo
                            </h3>
                            </div>
                    </div>
                </div>

                </transition>
        </div>
    </main>

    </div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                currentView: 'dashboard',
                isDark: false,
                modals: {
                    exam: false,
                    event: false,
                    time: false
                },
                editingExam: null,
                selectedExamForTime: null,
                customTimeMinutes: '',
                showPomoSettings: false,

                navItems: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'ph-squares-four' },
                    { id: 'exams', label: 'Libretto', icon: 'ph-books' },
                    { id: 'roadmap', label: 'Roadmap', icon: 'ph-path' },
                    { id: 'planning', label: 'Focus', icon: 'ph-timer' },
                    { id: 'calendar', label: 'Calendario', icon: 'ph-calendar' },
                    { id: 'settings', label: 'Opzioni', icon: 'ph-gear' }
                ],

                settings: {
                    cfuTotali: 180,
                    thesisPoints: 4
                },
                
                exams: [],
                events: [],
                todos: [],
                roadmapItems: [],
                
                formRoadmap: {
                    subjectId: null,
                    date: new Date().toISOString().split('T')[0],
                    topic: ''
                },
                roadmapDate: new Date(),

                userStats: {
                    streak: 0,
                    lastStudyDate: null
                },
                
                formExam: {
                    name: '',
                    cfu: 6,
                    semestre: 1,
                    superato: false,
                    grade: null,
                    lode: false,
                    note: '',
                    studyHours: 0
                },
                
                formEvent: {
                    title: '',
                    date: '',
                    type: 'Scritto',
                    room: ''
                },
                
                newTodo: '',

                // Configurazione Pomodoro Timer
                pomo: {
                    active: false,
                    mode: 'work',
                    timeLeft: 2700,
                    totalTime: 2700,
                    endTime: null,
                    interval: null,
                    settings: { work: 45, break: 10 },
                    selectedExamId: null
                },

                today: new Date(),
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                chartInstance: null
            }
        },
        computed: {
            sortedExams() {
                return [...this.exams].sort((a, b) => a.semestre - b.semestre || a.name.localeCompare(b.name));
            },
            sortedEvents() {
                return this.events
                    .filter(e => new Date(e.date) >= new Date().setHours(0, 0, 0, 0))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            },
            upcomingEvents() {
                return this.sortedEvents.slice(0, 3);
            },
            groupedRoadmap() {
                const groups = {};
                const sorted = [...this.roadmapItems].sort((a, b) => new Date(a.date) - new Date(b.date));
                sorted.forEach(item => {
                    if (!groups[item.date]) groups[item.date] = [];
                    groups[item.date].push(item);
                });
                return groups;
            },
            roadmapMonth() { return this.roadmapDate.getMonth(); },
            roadmapYear() { return this.roadmapDate.getFullYear(); },
            roadmapMonthName() { return this.roadmapDate.toLocaleString('it-IT', { month: 'long' }); },
            roadmapDaysInMonth() { return new Date(this.roadmapYear, this.roadmapMonth + 1, 0).getDate(); },
            roadmapFirstDay() {
                let day = new Date(this.roadmapYear, this.roadmapMonth, 1).getDay();
                return day === 0 ? 6 : day - 1;
            },
            kpi() {
                const passed = this.exams.filter(e => e.superato);
                const cfu = passed.reduce((sum, e) => sum + e.cfu, 0);
                
                if (!passed.length) return { mediaAritmetica: 0, mediaPonderata: 0, cfuAttuali: 0, votoLaurea: 0 };
                
                const sumV = passed.reduce((sum, e) => sum + (e.lode ? 31 : Number(e.grade)), 0);
                const sumP = passed.reduce((sum, e) => sum + ((e.lode ? 30 : Number(e.grade)) * e.cfu), 0);
                const mP = sumP / cfu;
                
                return {
                    mediaAritmetica: (sumV / passed.length).toFixed(2),
                    mediaPonderata: mP.toFixed(2),
                    cfuAttuali: cfu,
                    votoLaurea: ((mP * 110) / 30 + (this.settings.thesisPoints || 0)).toFixed(1)
                }
            },
            alerts() {
                const a = [];
                if (this.kpi.mediaPonderata > 0 && this.kpi.mediaPonderata < 22) 
                    a.push({ type: 'warning', icon: 'ph-warning', msg: 'Attenzione alla media!' });
                
                if (this.kpi.mediaPonderata >= 28) 
                    a.push({ type: 'success', icon: 'ph-thumbs-up', msg: 'Media eccellente, continua cosÃ¬!' });
                
                const urgent = this.upcomingEvents.find(e => this.getDaysDiff(e.date) <= 3);
                if (urgent) 
                    a.push({ type: 'warning', icon: 'ph-alarm', msg: `Scadenza vicina: ${urgent.title}` });
                
                if (this.userStats.streak > 3) 
                    a.push({ type: 'success', icon: 'ph-fire', msg: `${this.userStats.streak} giorni di fila! ðŸ”¥` });
                
                return a;
            },
            daysInMonth() { return new Date(this.currentYear, this.currentMonth + 1, 0).getDate(); },
            firstDayOfMonth() {
                let day = new Date(this.currentYear, this.currentMonth, 1).getDay();
                return day === 0 ? 6 : day - 1;
            },
            monthName() { return new Date(this.currentYear, this.currentMonth).toLocaleString('it-IT', { month: 'long' }); }
        },
        watch: {
            exams: { handler() { this.saveData(); if (this.currentView === 'dashboard') this.renderChartWithDelay(); }, deep: true },
            events: { handler() { this.saveData(); }, deep: true },
            todos: { handler() { this.saveData(); }, deep: true },
            roadmapItems: { handler() { this.saveData(); }, deep: true },
            settings: { handler() { this.saveData(); }, deep: true },
            currentView(newVal) { if (newVal === 'dashboard') this.renderChartWithDelay(); }
        },
        mounted() {
            this.loadData();
            this.updateStreak();
            const savedTheme = localStorage.getItem('uni_theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                this.isDark = true;
                document.documentElement.classList.add('dark');
            }
            if (this.currentView === 'dashboard') this.renderChartWithDelay();
        },
        methods: {
            getSubjectStyle(id, isInput) {
                if (!id) return isInput ? 'bg-white dark:bg-slate-800 text-slate-500 border-gray-200 dark:border-slate-700 hover:border-indigo-300' : 'bg-slate-100 text-slate-500';
                const palettes = ['bg-indigo-50 text-indigo-700 border-indigo-200', 'bg-emerald-50 text-emerald-700 border-emerald-200', 'bg-amber-50 text-amber-700 border-amber-200', 'bg-rose-50 text-rose-700 border-rose-200', 'bg-cyan-50 text-cyan-700 border-cyan-200', 'bg-violet-50 text-violet-700 border-violet-200', 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200', 'bg-lime-50 text-lime-700 border-lime-200', 'bg-sky-50 text-sky-700 border-sky-200'];
                const index = Math.abs(id) % palettes.length;
                return isInput ? `${palettes[index]} border-2 focus:ring-2 ring-opacity-20` : palettes[index];
            },
            toggleTheme() {
                this.isDark = !this.isDark;
                document.documentElement.classList.toggle('dark', this.isDark);
                localStorage.setItem('uni_theme', this.isDark ? 'dark' : 'light');
            },
            saveData() {
                localStorage.setItem('uni_data_v16', JSON.stringify({
                    exams: this.exams,
                    events: this.events,
                    todos: this.todos,
                    roadmapItems: this.roadmapItems,
                    settings: this.settings,
                    userStats: this.userStats,
                    pomoSettings: this.pomo.settings
                }));
            },
            loadData() {
                const d = JSON.parse(localStorage.getItem('uni_data_v16') || localStorage.getItem('uni_data_v15') || localStorage.getItem('uni_data_v14'));
                if (d) {
                    this.exams = d.exams || [];
                    this.events = d.events || [];
                    this.todos = d.todos || [];
                    this.roadmapItems = d.roadmapItems || [];
                    this.settings = d.settings || this.settings;
                    this.userStats = d.userStats || this.userStats;
                    if (d.pomoSettings) {
                        this.pomo.settings = d.pomoSettings;
                        this.resetPomo();
                    }
                }
            },
            updateStreak() {
                const today = new Date().toDateString();
                if (this.userStats.lastStudyDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    // Logica streak omessa per brevitÃ , intatta
                }
            },
            logStudyActivity() {
                const today = new Date().toDateString();
                if (this.userStats.lastStudyDate !== today) {
                    this.userStats.streak++;
                    this.userStats.lastStudyDate = today;
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
                }
            },
            openTimeModal(exam) {
                this.selectedExamForTime = exam;
                this.customTimeMinutes = '';
                this.modals.time = true;
            },
            addTime(minutes) {
                if (!minutes || minutes <= 0) return;
                if (this.selectedExamForTime) {
                    const hoursToAdd = parseFloat((minutes / 60).toFixed(2));
                    this.selectedExamForTime.studyHours = (this.selectedExamForTime.studyHours || 0) + hoursToAdd;
                    this.logStudyActivity();
                    this.modals.time = false;
                }
            },
            formatStudyTime(hours) {
                if (!hours) return '0h';
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return h === 0 ? `${m}m` : (m === 0 ? `${h}h` : `${h}h ${m}m`);
            },
            addToRoadmap() {
                if (!this.formRoadmap.topic || !this.formRoadmap.date) return;
                this.roadmapItems.push({
                    id: Date.now(),
                    subjectId: this.formRoadmap.subjectId,
                    date: this.formRoadmap.date,
                    topic: this.formRoadmap.topic,
                    done: false
                });
                this.formRoadmap.topic = '';
            },
            toggleRoadmapItem(item) {
                item.done = !item.done;
                if (item.done) this.logStudyActivity();
            },
            deleteRoadmapItem(id) {
                this.roadmapItems = this.roadmapItems.filter(i => i.id !== id);
            },
            getExamName(id) {
                if (!id) return 'Generale';
                const e = this.exams.find(ex => ex.id === id);
                return e ? e.name : 'Materia';
            },
            formatDateHeader(dateStr) {
                const d = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const inputDate = new Date(dateStr);
                inputDate.setHours(0, 0, 0, 0);
                if (inputDate.getTime() === today.getTime()) return 'Oggi';
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                if (inputDate.getTime() === tomorrow.getTime()) return 'Domani';
                return d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            },
            changeRoadmapMonth(val) {
                this.roadmapDate = new Date(this.roadmapYear, this.roadmapMonth + val, 1);
            },
            getRoadmapTasksForDate(day) {
                const dateStr = `${this.roadmapYear}-${String(this.roadmapMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return this.roadmapItems.filter(i => i.date === dateStr);
            },
            openModal(type) {
                if (type === 'exam') {
                    this.editingExam = null;
                    this.formExam = { name: '', cfu: 6, semestre: 1, superato: false, grade: null, lode: false, note: '', studyHours: 0 };
                } else {
                    this.formEvent = { title: '', date: new Date().toISOString().split('T')[0], type: 'Scritto', room: '' };
                }
                this.modals[type] = true;
            },
            saveExam() {
                if (!this.formExam.name) return;
                if (this.editingExam) Object.assign(this.editingExam, this.formExam);
                else this.exams.push({ ...this.formExam, id: Date.now() });
                this.modals.exam = false;
            },
            editExam(e) {
                this.editingExam = e;
                this.formExam = { ...e };
                this.modals.exam = true;
            },
            deleteExam(id) {
                if (confirm('Eliminare?')) this.exams = this.exams.filter(e => e.id !== id);
            },
            saveEvent() {
                if (!this.formEvent.title) return;
                this.events.push({ ...this.formEvent, id: Date.now() });
                this.modals.event = false;
            },
            deleteEvent(id) {
                if (confirm('Eliminare?')) this.events = this.events.filter(e => e.id !== id);
            },
            openDayModal(day) {
                this.formEvent.date = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                this.modals.event = true;
            },
            getEventsForDay(d) {
                const s = `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                return this.events.filter(e => e.date === s);
            },
            getEventColorClass(t) {
                return t === 'Scritto' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : t === 'Orale' ? 'bg-orange-50 text-orange-700 border-orange-200' : 'bg-emerald-50 text-emerald-700 border-emerald-200';
            },
            getDaysDiff(d) {
                return Math.ceil((new Date(d) - new Date().setHours(0, 0, 0, 0)) / (1000 * 60 * 60 * 24));
            },
            changeMonth(d) {
                this.currentMonth += d;
                if (this.currentMonth > 11) {
                    this.currentMonth = 0;
                    this.currentYear++;
                } else if (this.currentMonth < 0) {
                    this.currentMonth = 11;
                    this.currentYear--;
                }
            },
            isToday(d) {
                const t = new Date();
                return d === t.getDate() && this.currentMonth === t.getMonth() && this.currentYear === t.getFullYear();
            },

            // --- TIMER LOGIC ---
            togglePomo() {
                if (this.pomo.active) {
                    clearInterval(this.pomo.interval);
                    this.pomo.active = false;
                } else {
                    this.pomo.active = true;
                    this.pomo.endTime = Date.now() + (this.pomo.timeLeft * 1000);

                    this.pomo.interval = setInterval(() => {
                        const now = Date.now();
                        const diff = Math.ceil((this.pomo.endTime - now) / 1000);

                        if (diff >= 0) {
                            this.pomo.timeLeft = diff;
                        } else {
                            this.pomo.timeLeft = 0;
                            clearInterval(this.pomo.interval);
                            this.pomo.active = false;
                            alert("Tempo scaduto!");
                            if (this.pomo.mode === 'work') {
                                this.logStudyActivity();
                                if (this.pomo.selectedExamId) {
                                    const ex = this.exams.find(e => e.id === this.pomo.selectedExamId);
                                    if (ex) {
                                        const mins = this.pomo.settings.work;
                                        const hours = parseFloat((mins / 60).toFixed(2));
                                        ex.studyHours = (ex.studyHours || 0) + hours;
                                        alert(`Aggiunte ${mins} min a ${ex.name}`);
                                    }
                                }
                            }
                            this.resetPomo();
                        }
                    }, 1000);
                }
            },
            resetPomo() {
                clearInterval(this.pomo.interval);
                this.pomo.active = false;
                this.pomo.timeLeft = (this.pomo.mode === 'work' ? this.pomo.settings.work : this.pomo.settings.break) * 60;
                this.pomo.totalTime = this.pomo.timeLeft;
            },
            setPomoMode(m) {
                this.pomo.mode = m;
                this.resetPomo();
            },
            applyPomoSettings() {
                this.showPomoSettings = false;
                this.resetPomo();
            },
            formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m}:${sec < 10 ? '0' : ''}${sec}`;
            },
            addTodo() {
                if (this.newTodo) {
                    this.todos.push({ id: Date.now(), text: this.newTodo, done: false });
                    this.newTodo = '';
                }
            },
            toggleTodo(t) { t.done = !t.done; },
            deleteTodo(id) { this.todos = this.todos.filter(t => t.id !== id); },

            // --- CHART LOGIC ---
            renderChartWithDelay() {
                nextTick(() => {
                    setTimeout(() => {
                        const ctx = document.getElementById('mainChart');
                        if (!ctx) return;
                        if (this.chartInstance) {
                            this.chartInstance.destroy();
                            this.chartInstance = null;
                        }
                        const passed = this.exams.filter(e => e.superato);

                        if (passed.length === 0) return;

                        const labels = passed.map(e => e.name);
                        const data = [];
                        let sum = 0;

                        passed.forEach((e, i) => {
                            const voto = e.lode ? 30 : Number(e.grade);
                            sum += voto;
                            data.push((sum / (i + 1)).toFixed(2));
                        });

                        this.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Media',
                                    data: data,
                                    borderColor: '#6366f1',
                                    backgroundColor: (c) => {
                                        const g = c.chart.ctx.createLinearGradient(0, 0, 0, 300);
                                        g.addColorStop(0, 'rgba(99,102,241,0.4)');
                                        g.addColorStop(1, 'rgba(99,102,241,0)');
                                        return g;
                                    },
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: '#fff',
                                    pointBorderColor: '#6366f1',
                                    pointRadius: 5
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { min: 18, max: 31, grid: { borderDash: [4, 4] } },
                                    x: { grid: { display: false } }
                                }
                            }
                        });
                    }, 350);
                });
            },
            exportData() {
                const s = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem('uni_data_v16'));
                const a = document.createElement('a');
                a.href = s;
                a.download = "uni_backup.json";
                document.body.appendChild(a);
                a.click();
                a.remove();
            },
            triggerImport() { this.$refs.fileInput.click(); },
            importData(e) {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        this.exams = d.exams;
                        this.events = d.events;
                        this.todos = d.todos;
                        this.roadmapItems = d.roadmapItems;
                        this.settings = d.settings;
                        this.userStats = d.userStats;
                        alert("Fatto!");
                    } catch (x) {
                        alert("Errore file");
                    }
                };
                r.readAsText(f);
            },
            resetAll() {
                if (confirm("Cancellare TUTTO?")) {
                    localStorage.removeItem('uni_data_v16');
                    location.reload();
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
