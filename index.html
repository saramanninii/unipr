<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                currentView: 'dashboard',
                isDark: false,
                modals: { exam: false, event: false },
                editingExam: null,
                
                navItems: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'ph-squares-four' },
                    { id: 'exams', label: 'Libretto', icon: 'ph-books' },
                    { id: 'roadmap', label: 'Roadmap', icon: 'ph-path' },
                    { id: 'calendar', label: 'Calendario', icon: 'ph-calendar' },
                    { id: 'settings', label: 'Opzioni', icon: 'ph-gear' }
                ],
                
                settings: { cfuTotali: 180, thesisPoints: 4 },
                exams: [], events: [],
                roadmapItems: [],
                formRoadmap: { subjectId: null, date: new Date().toISOString().split('T')[0], topic: '' },
                roadmapDate: new Date(),

                userStats: { streak: 0, lastStudyDate: null },
                
                // Nota: grade inizializzato a null per gestire le idoneità
                formExam: { name: '', cfu: 6, semestre: 1, superato: false, grade: null, lode: false, note: '', studyHours: 0 },
                formEvent: { title: '', date: '', type: 'Scritto', room: '' },

                today: new Date(), currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(),
                chartInstance: null
            }
        },
        computed: {
            sortedExams() { return [...this.exams].sort((a,b) => a.semestre - b.semestre || a.name.localeCompare(b.name)); },
            sortedEvents() { return this.events.filter(e => new Date(e.date) >= new Date().setHours(0,0,0,0)).sort((a,b) => new Date(a.date) - new Date(b.date)); },
            upcomingEvents() { return this.sortedEvents.slice(0, 3); },
            groupedRoadmap() {
                const groups = {};
                const sorted = [...this.roadmapItems].sort((a, b) => new Date(a.date) - new Date(b.date));
                sorted.forEach(item => {
                    if (!groups[item.date]) groups[item.date] = [];
                    groups[item.date].push(item);
                });
                return groups;
            },
            roadmapMonth() { return this.roadmapDate.getMonth(); },
            roadmapYear() { return this.roadmapDate.getFullYear(); },
            roadmapMonthName() { return this.roadmapDate.toLocaleString('it-IT', { month: 'long' }); },
            roadmapDaysInMonth() { return new Date(this.roadmapYear, this.roadmapMonth + 1, 0).getDate(); },
            roadmapFirstDay() { 
                let day = new Date(this.roadmapYear, this.roadmapMonth, 1).getDay(); 
                return day === 0 ? 6 : day - 1; 
            },
            kpi() {
                // 1. Tutti gli esami superati (per il conteggio CFU Totale)
                const passed = this.exams.filter(e => e.superato);
                const cfuTotaliAcquisiti = passed.reduce((sum, e) => sum + e.cfu, 0);

                // 2. Solo esami CON VOTO (escludiamo idoneità dove grade è 0, null o vuoto)
                const gradedExams = passed.filter(e => e.grade && Number(e.grade) > 0);

                if (!gradedExams.length) return { mediaAritmetica: 0, mediaPonderata: 0, cfuAttuali: cfuTotaliAcquisiti, votoLaurea: 0 };
                
                // Media Aritmetica: Somma voti / Numero esami con voto
                const sumV = gradedExams.reduce((sum, e) => sum + (e.lode ? 31 : Number(e.grade)), 0); 
                
                // Media Ponderata: Somma (Voto * CFU) / Somma CFU degli esami CON VOTO
                const sumP = gradedExams.reduce((sum, e) => sum + ((e.lode ? 30 : Number(e.grade)) * e.cfu), 0);
                const cfuDenominatore = gradedExams.reduce((sum, e) => sum + e.cfu, 0); // CFU usati per la media
                
                const mP = sumP / cfuDenominatore;

                return { 
                    mediaAritmetica: (sumV / gradedExams.length).toFixed(2), 
                    mediaPonderata: mP.toFixed(2), 
                    cfuAttuali: cfuTotaliAcquisiti, 
                    votoLaurea: ((mP*110)/30 + (this.settings.thesisPoints||0)).toFixed(1) 
                }
            },
            alerts() {
                const a = [];
                if (this.kpi.mediaPonderata > 0 && this.kpi.mediaPonderata < 22) a.push({ type:'warning', icon:'ph-warning', msg:'Attenzione alla media!' });
                if (this.kpi.mediaPonderata >= 28) a.push({ type:'success', icon:'ph-thumbs-up', msg:'Media eccellente, continua così!' });
                const urgent = this.upcomingEvents.find(e => this.getDaysDiff(e.date) <= 3);
                if(urgent) a.push({ type:'warning', icon:'ph-alarm', msg: `Scadenza vicina: ${urgent.title}` });
                return a;
            },
            daysInMonth() { return new Date(this.currentYear, this.currentMonth + 1, 0).getDate(); },
            firstDayOfMonth() { let day = new Date(this.currentYear, this.currentMonth, 1).getDay(); return day === 0 ? 6 : day - 1; },
            monthName() { return new Date(this.currentYear, this.currentMonth).toLocaleString('it-IT', { month: 'long' }); }
        },
        watch: {
            exams: { handler() { this.saveData(); if(this.currentView==='dashboard') this.renderChartWithDelay(); }, deep: true },
            events: { handler() { this.saveData(); }, deep: true },
            roadmapItems: { handler() { this.saveData(); }, deep: true },
            settings: { handler() { this.saveData(); }, deep: true },
            currentView(newVal) { if (newVal === 'dashboard') this.renderChartWithDelay(); }
        },
        mounted() {
            this.loadData();
            const savedTheme = localStorage.getItem('uni_theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) { this.isDark = true; document.documentElement.classList.add('dark'); }
            if(this.currentView === 'dashboard') this.renderChartWithDelay();
        },
        methods: {
            getSubjectStyle(id, isInput) {
                if (!id) return isInput ? 'bg-white dark:bg-slate-800 text-slate-500 border-gray-200 dark:border-slate-700 hover:border-indigo-300' : 'bg-slate-100 text-slate-500';
                const palettes = ['bg-indigo-50 text-indigo-700 border-indigo-200', 'bg-emerald-50 text-emerald-700 border-emerald-200', 'bg-amber-50 text-amber-700 border-amber-200', 'bg-rose-50 text-rose-700 border-rose-200', 'bg-cyan-50 text-cyan-700 border-cyan-200', 'bg-violet-50 text-violet-700 border-violet-200', 'bg-fuchsia-50 text-fuchsia-700 border-fuchsia-200', 'bg-lime-50 text-lime-700 border-lime-200', 'bg-sky-50 text-sky-700 border-sky-200'];
                const index = Math.abs(id) % palettes.length;
                return isInput ? `${palettes[index]} border-2 focus:ring-2 ring-opacity-20` : palettes[index];
            },
            toggleTheme() { this.isDark=!this.isDark; document.documentElement.classList.toggle('dark', this.isDark); localStorage.setItem('uni_theme', this.isDark?'dark':'light'); },
            saveData() { localStorage.setItem('uni_data_v16', JSON.stringify({ exams: this.exams, events: this.events, todos: [], roadmapItems: this.roadmapItems, settings: this.settings, userStats: this.userStats, pomoSettings: {} })); },
            loadData() {
                const d = JSON.parse(localStorage.getItem('uni_data_v16') || localStorage.getItem('uni_data_v15') || localStorage.getItem('uni_data_v14'));
                if(d) { 
                    this.exams=d.exams||[]; this.events=d.events||[]; this.roadmapItems=d.roadmapItems||[];
                    this.settings=d.settings||this.settings; this.userStats=d.userStats||this.userStats;
                }
            },
            logStudyActivity() {
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } }); 
            },
            addToRoadmap() {
                if(!this.formRoadmap.topic || !this.formRoadmap.date) return;
                this.roadmapItems.push({ id: Date.now(), subjectId: this.formRoadmap.subjectId, date: this.formRoadmap.date, topic: this.formRoadmap.topic, done: false });
                this.formRoadmap.topic = '';
            },
            toggleRoadmapItem(item) { item.done = !item.done; if(item.done) this.logStudyActivity(); },
            deleteRoadmapItem(id) { this.roadmapItems = this.roadmapItems.filter(i => i.id !== id); },
            getExamName(id) { 
                if(!id) return 'Generale';
                const e = this.exams.find(ex => ex.id === id); return e ? e.name : 'Materia';
            },
            formatDateHeader(dateStr) {
                const d = new Date(dateStr); const today = new Date(); today.setHours(0,0,0,0); const inputDate = new Date(dateStr); inputDate.setHours(0,0,0,0);
                if(inputDate.getTime() === today.getTime()) return 'Oggi';
                const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                if(inputDate.getTime() === tomorrow.getTime()) return 'Domani';
                return d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
            },
            changeRoadmapMonth(val) { this.roadmapDate = new Date(this.roadmapYear, this.roadmapMonth + val, 1); },
            getRoadmapTasksForDate(day) {
                const dateStr = `${this.roadmapYear}-${String(this.roadmapMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                return this.roadmapItems.filter(i => i.date === dateStr);
            },
            openModal(type) { if(type==='exam'){this.editingExam=null;this.formExam={name:'',cfu:6,semestre:1,superato:false,grade:null,lode:false,note:'',studyHours:0}}else{this.formEvent={title:'',date:new Date().toISOString().split('T')[0],type:'Scritto',room:''}} this.modals[type]=true; },
            saveExam() { if(!this.formExam.name)return; if(this.editingExam) Object.assign(this.editingExam, this.formExam); else this.exams.push({...this.formExam, id:Date.now()}); this.modals.exam=false; },
            editExam(e) { this.editingExam=e; this.formExam={...e}; this.modals.exam=true; },
            deleteExam(id) { if(confirm('Eliminare?')) this.exams=this.exams.filter(e=>e.id!==id); },
            saveEvent() { if(!this.formEvent.title)return; this.events.push({...this.formEvent, id:Date.now()}); this.modals.event=false; },
            deleteEvent(id) { if(confirm('Eliminare?')) this.events=this.events.filter(e=>e.id!==id); },
            openDayModal(day) { this.formEvent.date=`${this.currentYear}-${String(this.currentMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; this.modals.event=true; },
            getEventsForDay(d) { const s=`${this.currentYear}-${String(this.currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; return this.events.filter(e=>e.date===s); },
            getEventColorClass(t) { return t==='Scritto'?'bg-indigo-50 text-indigo-700 border-indigo-200':t==='Orale'?'bg-orange-50 text-orange-700 border-orange-200':'bg-emerald-50 text-emerald-700 border-emerald-200'; },
            getDaysDiff(d) { return Math.ceil((new Date(d)-new Date().setHours(0,0,0,0))/(1000*60*60*24)); },
            changeMonth(d) { this.currentMonth+=d; if(this.currentMonth>11){this.currentMonth=0;this.currentYear++} else if(this.currentMonth<0){this.currentMonth=11;this.currentYear--} },
            isToday(d) { const t=new Date(); return d===t.getDate() && this.currentMonth===t.getMonth() && this.currentYear===t.getFullYear(); },
            
            // --- CHART CORRETTO ---
            renderChartWithDelay() {
                nextTick(() => {
                    setTimeout(() => {
                        const ctx = document.getElementById('mainChart');
                        if(!ctx) return;
                        if(this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; }
                        
                        // FILTRO: Solo esami superati E con voto valido (> 0)
                        const gradedPassed = this.exams.filter(e => e.superato && e.grade && Number(e.grade) > 0);
                        
                        if(gradedPassed.length === 0) return;

                        // Ordiniamo per cronologia (se ci fosse una data) o per nome/id come fallback per mostrare l'evoluzione
                        // Qui usiamo l'ordine dell'array, ideale sarebbe avere una data esame.
                        
                        const labels = gradedPassed.map(e => e.name);
                        const data = []; let sum = 0;
                        
                        gradedPassed.forEach((e, i) => { 
                            const voto = e.lode ? 30 : Number(e.grade);
                            sum += voto; 
                            data.push((sum / (i + 1)).toFixed(2)); 
                        });
                        
                        this.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Media', data: data, borderColor: '#6366f1',
                                    backgroundColor: (c) => { const g = c.chart.ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,'rgba(99,102,241,0.4)'); g.addColorStop(1,'rgba(99,102,241,0)'); return g; },
                                    fill: true, tension: 0.4, pointBackgroundColor: '#fff', pointBorderColor: '#6366f1', pointRadius: 5
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 18, max: 31, grid: { borderDash: [4, 4] } }, x: { grid: { display: false } } } }
                        });
                    }, 350);
                });
            },
            exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem('uni_data_v16')); const a = document.createElement('a'); a.href=s; a.download="uni_backup.json"; document.body.appendChild(a); a.click(); a.remove(); },
            triggerImport() { this.$refs.fileInput.click(); },
            importData(e) {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => { try { const d=JSON.parse(ev.target.result); this.exams=d.exams; this.events=d.events; this.roadmapItems=d.roadmapItems; this.settings=d.settings; this.userStats=d.userStats; alert("Fatto!"); } catch(x){ alert("Errore file"); } };
                r.readAsText(f);
            },
            resetAll() { if(confirm("Cancellare TUTTO?")) { localStorage.removeItem('uni_data_v16'); location.reload(); } }
        }
    }).mount('#app');
</script>
